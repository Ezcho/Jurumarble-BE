<!DOCTYPE html>
<html>
<head>
  <title>Map CRUD</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<h2>Maps CRUD</h2>

<!-- Create Form -->
<form id="create-form">
  <h3>Create Map</h3>
  ID: <input type="text" id="map-id"><br>
  Name: <input type="text" id="map-name"><br><br>
  <input type="submit" value="Create">
</form>

<br>

<!-- Update Form -->
<form id="update-form">
  <h3>Update Map</h3>
  ID: <input type="number" id="update-id"><br>
  Name: <input type="text" id="update-name"><br><br>
  <input type="submit" value="Update">
</form>

<br>

<!-- Delete Form -->
<form id="delete-form">
  <h3>Delete Map</h3>
  ID: <input type="number" id="delete-id"><br><br>
  <input type="submit" value="Delete">
</form>

<br>

<button onclick="getAllMaps()">Get All Maps</button>
<div id="maps-list"></div>


<!-- Input for game creation -->
<form id="start-game-form">
  Stack: <input type="number" id="game-stack-start"><br>
  Team Count: <input type="text" id="team-count"><br>
  <button type="button" onclick="startGame()">Start Game</button>
</form>

<!-- Input for team updates -->
<h3>Update Team</h3>
<form id="team-update-form">
  Game ID: <input type="text" id="game-id-update"><br>
  Name: <textarea id="team-name"></textarea><br>
  Position: <textarea id="team-position"></textarea><br>
  <button type="button" onclick="updateTeam()">Update Team</button>
</form>

<!-- Delete game -->
<button onclick="deleteGame()">Delete Game</button>
<script>
  async function getAllMaps() {
    try {
      let response = await fetch("/api/v1/maps");
      let data = await response.json();

      let html = '';
      data.forEach(map => {
        html += 'ID: ' + map.id + ', Name: ' + map.name + '<br>';
      });
      document.querySelector('#maps-list').innerHTML = html;
    } catch (error) {
      console.error("Error fetching maps:", error);
    }
  }

  document.querySelector("#create-form").addEventListener('submit', async function(e) {
    e.preventDefault();
    let id = document.querySelector("#map-id").value;
    let name = document.querySelector("#map-name").value;
    try {
      await fetch("/api/v1/maps", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({id: id, name: name})
      });
      alert('Map created!');
      await getAllMaps();
    } catch (error) {
      console.error("Error creating map:", error);
    }
  });

  document.querySelector("#update-form").addEventListener('submit', async function(e) {
    e.preventDefault();
    let id = document.querySelector("#update-id").value;
    let name = document.querySelector("#update-name").value;
    try {
      await fetch("/api/v1/maps/" + id, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({name: name})
      });
      alert('Map updated!');
      await getAllMaps();
    } catch (error) {
      console.error("Error updating map:", error);
    }
  });

  document.querySelector("#delete-form").addEventListener('submit', async function(e) {
    e.preventDefault();
    let id = document.querySelector("#delete-id").value;
    try {
      await fetch("/api/v1/maps/" + id, {
        method: 'DELETE'
      });
      alert('Map deleted!');
      await getAllMaps();
    } catch (error) {
      console.error("Error deleting map:", error);
    }
  });

  async function startGame() {
    const stackValue = document.querySelector('#game-stack-start').value;
    try {
      let response = await fetch("/api/v1/status/start", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({stack: stackValue}) // Use the stack value from the form
      });
      let data = await response.json();
      document.querySelector('#game-id-update').value = data.gameId;  // Set the game ID for the update form
      alert('Game started!');
    } catch (error) {
      console.error("Error starting game:", error);
    }
  }


  async function updateTeam() {
    const gameId = document.querySelector('#game-id-update').value;
    const name = document.querySelector('#team-name').value;
    const position = document.querySelector('#team-position').value;

    try {
      // 먼저 기존의 게임 정보를 가져옵니다.
      let response = await fetch("/api/v1/status/" + gameId);
      let gameData = await response.json();

      // 새로운 팀 정보를 추가합니다.
      gameData.teams.push({
        name: name,
        position: position
      });

      // 업데이트 요청을 보냅니다.
      await fetch("/api/v1/status/" + gameId, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(gameData)
      });

      alert('Team updated!');
    } catch (error) {
      console.error("Error updating team:", error);
    }
  }


  async function deleteGame() {
    try {
      await fetch("/api/v1/status/end", {
        method: 'POST'
      });
      alert('Game deleted based on client IP!');
    } catch (error) {
      console.error("Error deleting game:", error);
    }
  }

  getAllMaps();

</script>
</body>
</html>
